# Phase 3: Advanced Automation Implementation Plan

**Created:** 2026-02-02
**Based on:** Research from 3 parallel agents (Session, TODO, Delegation APIs)
**Confidence:** HIGH (verified via Context7, Official Docs, SDK)

---

## Executive Summary

Phase 3 adds three core capabilities:
1. **Stop Hook Enforcement** - Prevent stop without TODO completion
2. **Hierarchical TODO System** - 20+ items with phase-based prefixes
3. **Session Metadata & Context Injection** - File-based persistence + noReply injection

### Critical Discovery

> **Plugin hooks DO NOT intercept subagent tool calls** (GitHub #5894)

This means governance MUST be enforced via:
- Agent prompts (embedded protocol)
- `permission.task` config (hierarchy restrictions)
- File-based state (not plugin memory)

---

## Implementation Tasks

### Task 1: Stop Hook - TODO Enforcement
**Priority:** HIGH | **Effort:** 2 hours | **Confidence:** MEDIUM

Implement `stop` hook to check for incomplete TODOs and prompt continuation.

```typescript
stop: async (input) => {
  const sessionId = input.sessionID
  const todos = await client.session.todo({ path: { id: sessionId } })
  const incomplete = todos.filter(t => 
    t.status === "pending" || t.status === "in_progress"
  )
  
  if (incomplete.length > 0) {
    await client.session.prompt({
      path: { id: sessionId },
      body: {
        parts: [{
          type: "text",
          text: `[iDumb Governance] ${incomplete.length} incomplete tasks:\n${incomplete.map(t => `- [${t.priority}] ${t.content}`).join('\n')}`
        }]
      }
    })
  }
}
```

**Files to modify:**
- `template/plugins/idumb-core.ts` - Add stop hook

---

### Task 2: Hierarchical TODO Convention
**Priority:** HIGH | **Effort:** 1 hour | **Confidence:** HIGH

Native OpenCode TODOs are flat. Use convention-based hierarchy:

```
[P1] Foundation Phase
[P1] └ Research: Context7 query
[P1] └ Research: WebSearch verification
[P2] Implementation Phase  
[P2] └ Core: Build main module
[V] Validation Required
```

**ID Convention:** `p1-research-1`, `p1-research-2`, `p2-core-1`

**Files to create:**
- `template/tools/idumb-todo.ts` - Helper for creating hierarchical TODOs

---

### Task 3: Session Metadata Storage
**Priority:** MEDIUM | **Effort:** 2 hours | **Confidence:** HIGH

Store custom session metadata in `.idumb/sessions/<sessionId>.json`:

```json
{
  "sessionId": "ses_abc123",
  "phase": 2,
  "governanceLevel": "strict",
  "createdBy": "gsd-planner",
  "delegationDepth": 1,
  "parentSession": null,
  "createdAt": 1738512000000,
  "lastUpdated": 1738515600000
}
```

**Files to modify:**
- `template/plugins/idumb-core.ts` - session.created/deleted hooks
- `template/tools/idumb-state.ts` - Session metadata functions

---

### Task 4: Context Injection via noReply
**Priority:** MEDIUM | **Effort:** 1 hour | **Confidence:** MEDIUM

Inject governance context at key moments:

1. **Session start** - Initial governance protocol
2. **After compaction** - Restore critical state
3. **Before delegation** - Hierarchy reminders

```typescript
await client.session.prompt({
  path: { id: sessionId },
  body: {
    noReply: true,
    parts: [{
      type: "text",
      text: `<idumb-governance>
Phase: ${state.phase}
Delegation Depth: ${state.depth}
Pending Validations: ${state.pendingValidations}
</idumb-governance>`
    }]
  }
})
```

**Files to modify:**
- `template/plugins/idumb-core.ts` - Add context injection

---

### Task 5: Agent Prompt Governance Protocol
**Priority:** HIGH | **Effort:** 2 hours | **Confidence:** HIGH

Since plugin hooks don't intercept subagents, embed governance in every agent:

```markdown
## iDumb Governance Protocol (MANDATORY)

BEFORE any action:
1. Check TODO list via todoread
2. Verify current phase matches intended work
3. If delegating, include phase context

AFTER completing work:
1. Update TODO status (completed/cancelled)
2. If blocked, mark as pending with reason
3. Return structured result to caller

CONSTRAINTS:
- Maximum delegation depth: 3
- No code modification without plan ID
- Validation required before phase transition
```

**Files to modify:**
- `template/agents/idumb-supreme-coordinator.md`
- `template/agents/idumb-high-governance.md`
- `template/agents/idumb-low-validator.md`
- `template/agents/idumb-builder.md`

---

### Task 6: Bounce-Back Pattern (Prompt-Based)
**Priority:** MEDIUM | **Effort:** 2 hours | **Confidence:** MEDIUM

Since no native bounce-back exists, implement via prompts:

**In delegating agent (coordinator):**
```markdown
When delegating via Task tool:
1. Include expected return format in prompt
2. After task returns, ALWAYS verify result
3. If validation fails, re-delegate with corrections
```

**In delegated agent (builder):**
```markdown
When completing work:
1. Return structured result with:
   - What was done
   - Files modified
   - Validation status
2. Never stop - let parent decide next step
```

**Files to modify:**
- All agent prompts with delegation sections

---

### Task 7: TODO Event Monitoring
**Priority:** LOW | **Effort:** 1 hour | **Confidence:** HIGH

Monitor `todo.updated` events to sync with governance state:

```typescript
event: async ({ event }) => {
  if (event.type === "todo.updated") {
    const sessionId = event.properties?.sessionID
    // Sync TODO state with .idumb/brain/state.json
    syncTodoState(directory, sessionId)
  }
}
```

**Files to modify:**
- `template/plugins/idumb-core.ts`

---

### Task 8: Compaction Hook Enhancement
**Priority:** MEDIUM | **Effort:** 1 hour | **Confidence:** HIGH

Enhance existing compaction hook to preserve TODO state:

```typescript
"experimental.session.compacting": async (input, output) => {
  const sessionId = input.sessionID
  const todos = await client.session.todo({ path: { id: sessionId } })
  
  output.context.push(`## [iDumb] TODO State (Preserved)
${todos.map(t => `- [${t.status}] ${t.content}`).join('\n')}

## Governance Context
Phase: ${state.phase}
Mode: ${state.framework}`)
}
```

**Files to modify:**
- `template/plugins/idumb-core.ts`

---

## Implementation Order

1. **Task 1: Stop Hook** (blocks testing)
2. **Task 5: Agent Prompts** (critical - plugin bypass)
3. **Task 2: TODO Hierarchy** (enables tracking)
4. **Task 3: Session Metadata** (persistence)
5. **Task 4: Context Injection** (enhancement)
6. **Task 8: Compaction Enhancement** (enhancement)
7. **Task 6: Bounce-Back** (advanced)
8. **Task 7: TODO Events** (polish)

---

## Validation Checklist

Before marking Phase 3 complete:

- [ ] Stop hook prevents stop with incomplete TODOs
- [ ] Hierarchical TODOs visible in UI with prefixes
- [ ] Session metadata persists across restarts
- [ ] Context injection works via noReply
- [ ] All 4 agents have governance protocol
- [ ] Bounce-back pattern works in coordinator
- [ ] TODO events sync with governance state
- [ ] Compaction preserves all critical state

---

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Stop hook unreliable | MEDIUM | HIGH | Fallback to session.idle check |
| noReply not consumed | LOW | MEDIUM | Test with different models |
| Agent bypass governance | HIGH | HIGH | Embed in prompts, not hooks |
| Plugin crash breaks OpenCode | LOW | HIGH | Try/catch on all hooks ✅ |

---

## Sources

- `.planning/research/SESSION-API-2026-02-02.md` (530 lines)
- `.planning/research/TODO-API-RESEARCH-2026-02-02.md` (494 lines)
- `.planning/research/DELEGATION-HOOKS-2026-02-02.md` (497 lines)
- OpenCode Official Docs
- Context7: /anomalyco/opencode, /sst/opencode-sdk-js

---

## Next Action

Begin Task 1: Implement Stop Hook in `idumb-core.ts`
